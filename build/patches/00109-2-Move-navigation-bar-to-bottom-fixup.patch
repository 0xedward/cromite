From: Your Name <you@example.com>
Date: Mon, 30 Jan 2023 15:13:51 +0000
Subject: 109-2 Move navigation bar to bottom fixup

---
 .../tab_management/TabListCoordinator.java    | 20 +++++++++++--------
 .../DropdownItemViewInfoListManager.java      | 15 ++++++++++----
 2 files changed, 23 insertions(+), 12 deletions(-)

diff --git a/chrome/android/features/tab_ui/java/src/org/chromium/chrome/browser/tasks/tab_management/TabListCoordinator.java b/chrome/android/features/tab_ui/java/src/org/chromium/chrome/browser/tasks/tab_management/TabListCoordinator.java
--- a/chrome/android/features/tab_ui/java/src/org/chromium/chrome/browser/tasks/tab_management/TabListCoordinator.java
+++ b/chrome/android/features/tab_ui/java/src/org/chromium/chrome/browser/tasks/tab_management/TabListCoordinator.java
@@ -105,7 +105,9 @@ public class TabListCoordinator
 
         TabListRecyclerView mRecyclerView;
 
-        int mTopPadding = 99999;
+        final int MAX_TOP_PADDING = 99999;
+        int mTopPadding = MAX_TOP_PADDING;
+
         int mLastPosition = -1;
         boolean mIsFirstLayout = true;
 
@@ -125,10 +127,10 @@ public class TabListCoordinator
         @Override
         public int getPaddingTop() {
             if (mContext.getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
-                mTopPadding = 99999;
+                mTopPadding = MAX_TOP_PADDING;
                 return 0;
             }
-            if (mTopPadding == 99999) return super.getPaddingTop();
+            if (mTopPadding == MAX_TOP_PADDING) return super.getPaddingTop();
             return mTopPadding;
         }
 
@@ -140,26 +142,28 @@ public class TabListCoordinator
         @Override
         public void scrollToPositionWithOffset(int position, int offset) {
             mLastPosition = position;
-            super.scrollToPositionWithOffset(position, getPaddingBottom());
+            super.scrollToPositionWithOffset(position, offset - getPaddingTop());
         }
 
         @Override
         public void onLayoutCompleted(RecyclerView.State state) {
             super.onLayoutCompleted(state);
 
-            if (state.isPreLayout()) return;
+            if (state.isPreLayout() || state.isMeasuring()) return;
             View lastView = findViewByPosition(findFirstVisibleItemPosition());
             if (lastView != null) {
+                if (mTopPadding == 0) mTopPadding = MAX_TOP_PADDING;
                 mTopPadding = Math.min(mTopPadding, mRecyclerView.getHeight() - lastView.getHeight());
                 if (mIsFirstLayout) {
                     mIsFirstLayout = false;
-                    scrollToPositionWithOffset(mLastPosition, 0);
+                    scrollToPositionWithOffset(mLastPosition, getPaddingTop() + getPaddingBottom());
                 }
             }
 
-            if (mLastPosition != -1 && mLastPosition >= state.getItemCount()) {
+            if (mLastPosition >= state.getItemCount()) {
                 ResetTopPosition();
-                scrollToPositionWithOffset(state.getItemCount()-getSpanCount(), 0);
+                scrollToPositionWithOffset(state.getItemCount()-getSpanCount(),
+                    getPaddingTop() + getPaddingBottom());
             }
         }
     }
diff --git a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListManager.java b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListManager.java
--- a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListManager.java
+++ b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListManager.java
@@ -11,6 +11,8 @@ import android.view.View;
 import androidx.annotation.NonNull;
 import androidx.annotation.Px;
 
+import org.chromium.chrome.browser.flags.CachedFeatureFlags;
+import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import org.chromium.chrome.browser.omnibox.OmniboxFeatures;
 import org.chromium.chrome.browser.omnibox.R;
 import org.chromium.chrome.browser.ui.theme.BrandedColorScheme;
@@ -165,6 +167,7 @@ class DropdownItemViewInfoListManager {
         GroupSection previousSection = null;
         GroupSection currentSection;
 
+        boolean toolbarToBottom = ChromeFeatureList.sMoveTopToolbarToBottom.isEnabled();
         for (int i = 0; i < mSourceViewInfoList.size(); i++) {
             final DropdownItemViewInfo item = mSourceViewInfoList.get(i);
             final PropertyModel model = item.model;
@@ -180,18 +183,22 @@ class DropdownItemViewInfoListManager {
                 var topMargin = applyRounding ? groupTopMargin : suggestionVerticalMargin;
                 var bottomMargin = applyRounding ? groupBottomMargin : suggestionVerticalMargin;
 
-                model.set(DropdownCommonProperties.BG_TOP_CORNER_ROUNDED, applyRounding);
+                model.set(toolbarToBottom ?
+                    DropdownCommonProperties.BG_BOTTOM_CORNER_ROUNDED :
+                    DropdownCommonProperties.BG_TOP_CORNER_ROUNDED, applyRounding);
                 // Do not have margin for the first suggestion, otherwise the first suggestion will
                 // have a big gap with the Omnibox.
-                model.set(DropdownCommonProperties.TOP_MARGIN,
+                model.set(toolbarToBottom ? DropdownCommonProperties.BOTTOM_MARGIN : DropdownCommonProperties.TOP_MARGIN,
                         previousItem == null
                                 ? getSuggestionListTopMargin(item.processor.getViewTypeId())
                                 : topMargin);
 
                 if (previousItem != null) {
                     previousItem.model.set(
-                            DropdownCommonProperties.BG_BOTTOM_CORNER_ROUNDED, applyRounding);
-                    previousItem.model.set(DropdownCommonProperties.BOTTOM_MARGIN, bottomMargin);
+                            toolbarToBottom ?
+                                DropdownCommonProperties.BG_TOP_CORNER_ROUNDED :
+                                DropdownCommonProperties.BG_BOTTOM_CORNER_ROUNDED, applyRounding);
+                    previousItem.model.set(toolbarToBottom ? DropdownCommonProperties.TOP_MARGIN : DropdownCommonProperties.BOTTOM_MARGIN, bottomMargin);
                 }
 
                 previousItem = item;
--
2.25.1
