From: Your Name <you@example.com>
Date: Tue, 31 Jan 2023 13:58:21 +0000
Subject: fix InitiatorOrigin (add fixup)

---
 .../chromium/chrome/browser/IntentHandler.java   | 16 +++++++++++++++-
 .../chrome/browser/LaunchIntentDispatcher.java   |  2 +-
 .../shared_intent/SharedIntentShareActivity.java |  1 +
 3 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
@@ -214,6 +214,9 @@ public class IntentHandler {
     private static final String EXTRA_TAB_LAUNCH_TYPE =
             "org.chromium.chrome.browser.tab_launch_type";
 
+    private static final String EXTRA_TAB_FORCE_INCOGNITO_TYPE =
+            "org.chromium.chrome.browser.force_incognito";
+
     /**
      * A hash code for the URL to verify intent data hasn't been modified.
      */
@@ -1443,6 +1446,17 @@ public class IntentHandler {
         return IntentUtils.safeGetSerializableExtra(intent, EXTRA_TAB_LAUNCH_TYPE);
     }
 
+    public static void setForceIncognitoMode(Intent intent) {
+        intent.putExtra(EXTRA_TAB_FORCE_INCOGNITO_TYPE, 1);
+        intent.putExtra(IntentHandler.EXTRA_OPEN_NEW_INCOGNITO_TAB, true);
+        setTabLaunchType(intent, TabLaunchType.FROM_EXTERNAL_APP);
+    }
+
+    public static boolean isForceIncognitoMode(Intent intent) {
+        Integer value = IntentUtils.safeGetSerializableExtra(intent, EXTRA_TAB_FORCE_INCOGNITO_TYPE);
+        return value == null ? false : value == 1;
+    }
+
     /**
      * Creates an Intent that will launch a ChromeTabbedActivity on the new tab page. The Intent
      * will be trusted and therefore able to launch Incognito tabs.
@@ -1580,7 +1594,7 @@ public class IntentHandler {
         String headers = getExtraHeadersFromIntent(intent);
         headers = maybeAddAdditionalContentHeaders(intent, url, headers);
 
-        if (IntentHandler.wasIntentSenderChrome(intent)) {
+        if (IntentHandler.wasIntentSenderChrome(intent) && !isForceIncognitoMode(intent)) {
             // Handle post data case.
             String postDataType =
                     IntentUtils.safeGetStringExtra(intent, IntentHandler.EXTRA_POST_DATA_TYPE);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
@@ -456,8 +456,8 @@ public class LaunchIntentDispatcher implements IntentHandler.IntentHandlerDelega
                     /*incognito*/true);
                 newIntent.setData(mIntent.getData());
                 newIntent.setPackage(applicationContext.getPackageName());
-                IntentHandler.setTabLaunchType(newIntent, TabLaunchType.FROM_EXTERNAL_APP);
                 newIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+                IntentHandler.setForceIncognitoMode(newIntent);
             }
 
             long time = SystemClock.elapsedRealtime();
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/sharing/shared_intent/SharedIntentShareActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/sharing/shared_intent/SharedIntentShareActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/sharing/shared_intent/SharedIntentShareActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/sharing/shared_intent/SharedIntentShareActivity.java
@@ -100,6 +100,7 @@ public class SharedIntentShareActivity
             chromeIntent.setData(Uri.parse(linkUrl));
             chromeIntent.setPackage(applicationContext.getPackageName());
             chromeIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+            IntentHandler.setForceIncognitoMode(chromeIntent);
 
             LaunchIntentDispatcher.dispatch(this, chromeIntent);
             finish();
--
2.25.1
