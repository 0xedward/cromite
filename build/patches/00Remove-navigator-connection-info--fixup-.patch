From: Your Name <you@example.com>
Date: Tue, 6 Sep 2022 08:35:08 +0000
Subject: Remove navigator.connection info (fixup)

---
 .../renderer/modules/netinfo/network_information.cc   |  6 +++---
 .../renderer/modules/netinfo/network_information.h    |  1 +
 .../platform/network/network_state_notifier.cc        | 11 +++++++++++
 .../platform/network/network_state_notifier.h         |  2 +-
 4 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/third_party/blink/renderer/modules/netinfo/network_information.cc b/third_party/blink/renderer/modules/netinfo/network_information.cc
--- a/third_party/blink/renderer/modules/netinfo/network_information.cc
+++ b/third_party/blink/renderer/modules/netinfo/network_information.cc
@@ -61,7 +61,7 @@ NetworkInformation::~NetworkInformation() {
 }
 
 bool NetworkInformation::IsObserving() const {
-  return false;
+  return !!connection_observer_handle_ || is_fake_observing_;
 }
 
 String NetworkInformation::type() const {
@@ -243,7 +243,7 @@ void NetworkInformation::ContextDestroyed() {
 }
 
 void NetworkInformation::StartObserving() {
-  //is_fake_observing_ = true;
+  is_fake_observing_ = true;
   if ((true)) return;
   if (!IsObserving() && !context_stopped_) {
     type_ = GetNetworkStateNotifier().ConnectionType();
@@ -255,7 +255,7 @@ void NetworkInformation::StartObserving() {
 }
 
 void NetworkInformation::StopObserving() {
-  //is_fake_observing_ = false;
+  is_fake_observing_ = false;
   if ((true)) return;
   if (IsObserving()) {
     DCHECK(connection_observer_handle_);
diff --git a/third_party/blink/renderer/modules/netinfo/network_information.h b/third_party/blink/renderer/modules/netinfo/network_information.h
--- a/third_party/blink/renderer/modules/netinfo/network_information.h
+++ b/third_party/blink/renderer/modules/netinfo/network_information.h
@@ -118,6 +118,7 @@ class NetworkInformation final
 
   std::unique_ptr<NetworkStateNotifier::NetworkStateObserverHandle>
       connection_observer_handle_;
+  bool is_fake_observing_ = false;
 };
 
 }  // namespace blink
diff --git a/third_party/blink/renderer/platform/network/network_state_notifier.cc b/third_party/blink/renderer/platform/network/network_state_notifier.cc
--- a/third_party/blink/renderer/platform/network/network_state_notifier.cc
+++ b/third_party/blink/renderer/platform/network/network_state_notifier.cc
@@ -522,6 +522,17 @@ NetworkStateNotifier::GetWebHoldbackDownlinkThroughputMbps() const {
   return absl::nullopt;
 }
 
+NetworkStateNotifier::NetworkStateNotifier() : has_override_(false) {
+  // set default data
+  // see third_party/blink/renderer/platform/network/network_state_notifier_test.cc
+  SetNetworkConnectionInfoOverride(
+    /*on_line*/true,
+    /*type*/WebConnectionType::kWebConnectionTypeUnknown,
+    /*effective_type*/absl::nullopt,
+    /*http_rtt_msec*/0,
+    /*max_bandwidth_mbps*/0);
+}
+
 void NetworkStateNotifier::GetMetricsWithWebHoldback(
     WebConnectionType* type,
     double* downlink_max_mbps,
diff --git a/third_party/blink/renderer/platform/network/network_state_notifier.h b/third_party/blink/renderer/platform/network/network_state_notifier.h
--- a/third_party/blink/renderer/platform/network/network_state_notifier.h
+++ b/third_party/blink/renderer/platform/network/network_state_notifier.h
@@ -122,7 +122,7 @@ class PLATFORM_EXPORT NetworkStateNotifier {
     scoped_refptr<base::SingleThreadTaskRunner> task_runner_;
   };
 
-  NetworkStateNotifier() : has_override_(false) {}
+  NetworkStateNotifier();
   NetworkStateNotifier(const NetworkStateNotifier&) = delete;
   NetworkStateNotifier& operator=(const NetworkStateNotifier&) = delete;
 
--
2.25.1
